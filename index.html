<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHubæ–‡ä»¶ä¼ è¾“</title>
    <style>
        :root {
            --primary-color: #2b3137; /* GitHubé£æ ¼é¢œè‰² */
            --secondary-color: #f6f8fa;
            --text-color: #24292e;
            --light-text: #586069;
            --border-radius: 6px;
            --box-shadow: 0 1px 3px rgba(27, 31, 35, 0.12);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }
        
        /* å…è´£åè®®æ¨¡æ€æ¡† */
        .disclaimer-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(27, 31, 35, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .disclaimer-content {
            background-color: white;
            border-radius: var(--border-radius);
            max-width: 800px;
            max-height: 80vh;
            padding: 30px;
            overflow-y: auto;
            box-shadow: var(--box-shadow);
        }
        
        .disclaimer-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-align: center;
        }
        
        .disclaimer-text {
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .disclaimer-buttons {
            display: flex;
            gap: 15px;
        }
        
        .disclaimer-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .agree-btn {
            background-color: #2ea44f;
            color: white;
        }
        
        .disagree-btn {
            background-color: #d73a49;
            color: white;
        }
        
        /* ä¸»åº”ç”¨å®¹å™¨ */
        .app-container {
            display: none;
            padding: 20px;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 600px;
            padding: 30px;
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            text-align: center;
            font-weight: 600;
            margin-bottom: 30px;
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .mode-selector {
            display: flex;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 5px;
            margin-bottom: 25px;
            border: 1px solid #e1e4e8;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .mode-btn.active {
            background-color: white;
            box-shadow: 0 1px 3px rgba(27, 31, 35, 0.12);
            color: var(--primary-color);
        }
        
        .panel {
            display: none;
        }
        
        .panel.active {
            display: block;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--light-text);
        }
        
        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e1e4e8;
            border-radius: var(--border-radius);
            font-size: 14px;
        }
        
        input[type="text"]:focus,
        input[type="file"]:focus {
            outline: none;
            border-color: #0366d6;
            box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.3);
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background-color: #2ea44f;
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .btn:hover {
            background-color: #2c974b;
        }
        
        .btn:disabled {
            background-color: #94d3a2;
            cursor: not-allowed;
        }
        
        .file-preview {
            width: 100%;
            border-radius: var(--border-radius);
            margin-top: 20px;
            padding: 15px;
            background-color: var(--secondary-color);
            border: 1px solid #e1e4e8;
            display: none;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .file-icon {
            font-size: 40px;
            margin-right: 15px;
            color: #0366d6;
        }
        
        .file-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .file-size {
            font-size: 12px;
            color: var(--light-text);
        }
        
        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: var(--border-radius);
            font-size: 14px;
            text-align: center;
            display: none;
            border: 1px solid;
        }
        
        .status.connecting {
            background-color: #f1f8ff;
            border-color: #c8e1ff;
            color: #0366d6;
            display: block;
        }
        
        .status.connected {
            background-color: #f0fff4;
            border-color: #c2f0c2;
            color: #22863a;
            display: block;
        }
        
        .status.error {
            background-color: #ffeef0;
            border-color: #f9c3c6;
            color: #cb2431;
            display: block;
        }
        
        .progress-container {
            margin-top: 15px;
            display: none;
        }
        
        .progress-bar {
            height: 6px;
            background-color: #e1e4e8;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: #2ea44f;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            font-size: 12px;
            color: var(--light-text);
            margin-top: 5px;
        }
        
        .confirmation-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(27, 31, 35, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .dialog-content {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 80%;
            max-width: 400px;
            box-shadow: var(--box-shadow);
        }
        
        .dialog-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .dialog-message {
            margin-bottom: 20px;
            color: var(--light-text);
        }
        
        .dialog-buttons {
            display: flex;
            gap: 10px;
        }
        
        .dialog-buttons button {
            flex: 1;
        }
        
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #e1e4e8;
            border-radius: var(--border-radius);
            padding: 10px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-item-name {
            word-break: break-all;
        }
        
        .file-item-size {
            color: var(--light-text);
            font-size: 12px;
            white-space: nowrap;
            margin-left: 10px;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(27, 31, 35, 0.1);
            border-radius: 50%;
            border-top-color: #0366d6;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- å…è´£åè®®æ¨¡æ€æ¡† -->
    <div id="disclaimer-modal" class="disclaimer-modal">
        <div class="disclaimer-content">
            <div class="disclaimer-title">å…è´£åè®®</div>
            <div class="disclaimer-text">
                <p><strong>é‡è¦æç¤ºï¼š</strong>æœ¬å·¥å…·ä»…ç”¨äºåˆæ³•æ–‡ä»¶ä¼ è¾“ã€‚</p>
                <p>1. æ‰€æœ‰æ–‡ä»¶ç›´æ¥åœ¨æ‚¨çš„è®¾å¤‡é—´ä¼ è¾“ï¼Œä¸ç»è¿‡ä»»ä½•æœåŠ¡å™¨ã€‚</p>
                <p>2. ç¦æ­¢ä¼ è¾“ä»»ä½•è¿æ³•å†…å®¹ã€‚</p>
                <p>3. ä½¿ç”¨æœ¬å·¥å…·å³è¡¨ç¤ºæ‚¨åŒæ„æ‰¿æ‹…å…¨éƒ¨è´£ä»»ã€‚</p>
            </div>
            <div class="disclaimer-buttons">
                <button id="disagree-btn" class="disclaimer-btn disagree-btn">ä¸åŒæ„</button>
                <button id="agree-btn" class="disclaimer-btn agree-btn">åŒæ„å¹¶ç»§ç»­</button>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app-container" class="app-container">
        <div class="container">
            <h1>GitHubæ–‡ä»¶ä¼ è¾“</h1>
            
            <div class="mode-selector">
                <button id="sender-btn" class="mode-btn active">å‘é€æ–‡ä»¶</button>
                <button id="receiver-btn" class="mode-btn">æ¥æ”¶æ–‡ä»¶</button>
            </div>
            
            <!-- å‘é€é¢æ¿ -->
            <div id="sender-panel" class="panel active">
                <div class="input-group">
                    <label for="file-input">é€‰æ‹©æ–‡ä»¶(æ”¯æŒä»»æ„ç±»å‹)</label>
                    <input type="file" id="file-input" multiple>
                </div>
                <div class="input-group">
                    <label for="sender-code">ä¼ è¾“ä»£å·</label>
                    <input type="text" id="sender-code" placeholder="è¾“å…¥å…±äº«ä»£ç ">
                </div>
                <div id="file-list" class="file-list" style="display: none;"></div>
                <button id="start-sending" class="btn">å¼€å§‹ä¼ è¾“</button>
                <div id="sender-status" class="status"></div>
                <div class="progress-container" id="sender-progress">
                    <div class="progress-bar">
                        <div class="progress" id="sender-progress-bar"></div>
                    </div>
                    <div class="progress-text" id="sender-progress-text">0%</div>
                </div>
                <div id="sender-preview" class="file-preview"></div>
            </div>
            
            <!-- æ¥æ”¶é¢æ¿ -->
            <div id="receiver-panel" class="panel">
                <div class="input-group">
                    <label for="receiver-code">ä¼ è¾“ä»£å·</label>
                    <input type="text" id="receiver-code" placeholder="è¾“å…¥å‘é€æ–¹æä¾›çš„ä»£ç ">
                </div>
                <button id="start-receiving" class="btn">å¼€å§‹æ¥æ”¶</button>
                <div id="receiver-status" class="status"></div>
                <div class="progress-container" id="receiver-progress">
                    <div class="progress-bar">
                        <div class="progress" id="receiver-progress-bar"></div>
                    </div>
                    <div class="progress-text" id="receiver-progress-text">0%</div>
                </div>
                <div id="receiver-preview" class="file-preview"></div>
            </div>
        </div>

        <!-- æ¥æ”¶ç¡®è®¤å¯¹è¯æ¡† -->
        <div id="confirmation-dialog" class="confirmation-dialog">
            <div class="dialog-content">
                <div class="dialog-title">æ¥æ”¶æ–‡ä»¶è¯·æ±‚</div>
                <div class="dialog-message" id="dialog-message"></div>
                <div id="incoming-files" class="file-list"></div>
                <div class="dialog-buttons">
                    <button id="confirm-receive" class="btn">æ¥æ”¶</button>
                    <button id="cancel-receive" class="btn" style="background-color: #d73a49;">æ‹’ç»</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // å…è´£åè®®å¤„ç†
            const disclaimerModal = document.getElementById('disclaimer-modal');
            const agreeBtn = document.getElementById('agree-btn');
            const disagreeBtn = document.getElementById('disagree-btn');
            const appContainer = document.getElementById('app-container');
            
            // æ£€æŸ¥æ˜¯å¦å·²åŒæ„å…è´£åè®®
            if(localStorage.getItem('disclaimerAgreed') === 'true') {
                disclaimerModal.style.display = 'none';
                appContainer.style.display = 'flex';
            }
            
            // åŒæ„æŒ‰é’®
            agreeBtn.addEventListener('click', function() {
                localStorage.setItem('disclaimerAgreed', 'true');
                disclaimerModal.style.display = 'none';
                appContainer.style.display = 'flex';
                initPeerJS();
            });
            
            // ä¸åŒæ„æŒ‰é’®
            disagreeBtn.addEventListener('click', function() {
                alert('æ‚¨å¿…é¡»åŒæ„å…è´£åè®®æ‰èƒ½ä½¿ç”¨æœ¬æœåŠ¡');
                window.location.href = 'about:blank';
            });
            
            // æ¨¡å¼åˆ‡æ¢
            const senderBtn = document.getElementById('sender-btn');
            const receiverBtn = document.getElementById('receiver-btn');
            const senderPanel = document.getElementById('sender-panel');
            const receiverPanel = document.getElementById('receiver-panel');
            
            senderBtn.addEventListener('click', function() {
                resetAll();
                senderBtn.classList.add('active');
                receiverBtn.classList.remove('active');
                senderPanel.classList.add('active');
                receiverPanel.classList.remove('active');
            });
            
            receiverBtn.addEventListener('click', function() {
                resetAll();
                receiverBtn.classList.add('active');
                senderBtn.classList.remove('active');
                receiverPanel.classList.add('active');
                senderPanel.classList.remove('active');
            });
            
            // å…¨å±€å˜é‡
            let peer;
            let conn;
            let fileReader = new FileReader();
            let currentFiles = [];
            let currentCode = '';
            let isReceivingConfirmed = false;
            let pendingFilesInfo = [];
            let receivedFiles = [];
            let currentFileIndex = 0;
            let currentFileOffset = 0;
            let totalSent = 0;
            let totalSize = 0;
            
            // å‘é€ç«¯å…ƒç´ 
            const fileInput = document.getElementById('file-input');
            const senderCodeInput = document.getElementById('sender-code');
            const startSendingBtn = document.getElementById('start-sending');
            const senderStatus = document.getElementById('sender-status');
            const senderPreview = document.getElementById('sender-preview');
            const senderProgress = document.getElementById('sender-progress');
            const senderProgressBar = document.getElementById('sender-progress-bar');
            const senderProgressText = document.getElementById('sender-progress-text');
            const fileList = document.getElementById('file-list');
            
            // æ¥æ”¶ç«¯å…ƒç´ 
            const receiverCodeInput = document.getElementById('receiver-code');
            const startReceivingBtn = document.getElementById('start-receiving');
            const receiverStatus = document.getElementById('receiver-status');
            const receiverPreview = document.getElementById('receiver-preview');
            const receiverProgress = document.getElementById('receiver-progress');
            const receiverProgressBar = document.getElementById('receiver-progress-bar');
            const receiverProgressText = document.getElementById('receiver-progress-text');
            
            // å¯¹è¯æ¡†å…ƒç´ 
            const confirmationDialog = document.getElementById('confirmation-dialog');
            const confirmReceiveBtn = document.getElementById('confirm-receive');
            const cancelReceiveBtn = document.getElementById('cancel-receive');
            const dialogMessage = document.getElementById('dialog-message');
            const incomingFilesList = document.getElementById('incoming-files');
            
            // æ–‡ä»¶é€‰æ‹©å¤„ç†
            fileInput.addEventListener('change', function(e) {
                currentFiles = Array.from(e.target.files);
                updateFileList();
            });
            
            function updateFileList() {
                if(currentFiles.length === 0) {
                    fileList.style.display = 'none';
                    return;
                }
                
                fileList.style.display = 'block';
                fileList.innerHTML = '';
                
                currentFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-item-name">${file.name}</div>
                        <div class="file-item-size">${formatFileSize(file.size)}</div>
                    `;
                    fileList.appendChild(fileItem);
                });
            }
            
            // å‘é€ç«¯é€»è¾‘
            startSendingBtn.addEventListener('click', startSending);
            
            function startSending() {
                currentCode = senderCodeInput.value.trim();
                
                if (currentFiles.length === 0) {
                    updateStatus(senderStatus, 'è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ–‡ä»¶', 'error');
                    return;
                }
                
                if (!currentCode) {
                    updateStatus(senderStatus, 'è¯·è¾“å…¥ä¼ è¾“ä»£å·', 'error');
                    return;
                }
                
                // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                startSendingBtn.disabled = true;
                startSendingBtn.textContent = 'å‡†å¤‡ä¼ è¾“...';
                
                // è®¡ç®—æ€»å¤§å°
                totalSize = currentFiles.reduce((sum, file) => sum + file.size, 0);
                
                // åˆå§‹åŒ–Peer
                peer = new Peer(currentCode + '-sender', {
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' }
                        ]
                    }
                });
                
                peer.on('open', function(id) {
                    updateStatus(senderStatus, 'ç­‰å¾…æ¥æ”¶æ–¹è¿æ¥...', 'connecting');
                    startSendingBtn.textContent = 'ç­‰å¾…æ¥æ”¶æ–¹...';
                    
                    // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
                    showFilesPreview(currentFiles, senderPreview);
                    
                    // ç­‰å¾…æ¥æ”¶æ–¹è¿æ¥
                    peer.on('connection', function(connection) {
                        conn = connection;
                        updateStatus(senderStatus, 'æ¥æ”¶æ–¹å·²è¿æ¥ï¼Œç­‰å¾…ç¡®è®¤...', 'connecting');
                        startSendingBtn.textContent = 'ç­‰å¾…æ¥æ”¶æ–¹ç¡®è®¤...';
                        
                        // å‘é€æ–‡ä»¶ä¿¡æ¯ç»™æ¥æ”¶æ–¹
                        const filesInfo = currentFiles.map(file => ({
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            lastModified: file.lastModified
                        }));
                        
                        conn.send({
                            type: 'files-info',
                            files: filesInfo,
                            totalSize: totalSize
                        });
                        
                        // ç›‘å¬æ¥æ”¶æ–¹çš„ç¡®è®¤
                        conn.on('data', function(data) {
                            if (data.type === 'receive-confirmed') {
                                updateStatus(senderStatus, 'æ¥æ”¶æ–¹å·²ç¡®è®¤ï¼Œå¼€å§‹ä¼ è¾“...', 'connected');
                                senderProgress.style.display = 'block';
                                startSendingBtn.textContent = 'ä¼ è¾“ä¸­...';
                                sendFilesData();
                            } else if (data.type === 'receive-canceled') {
                                updateStatus(senderStatus, 'æ¥æ”¶æ–¹æ‹’ç»äº†æ–‡ä»¶ä¼ è¾“', 'error');
                                startSendingBtn.disabled = false;
                                startSendingBtn.textContent = 'å¼€å§‹ä¼ è¾“';
                                conn.close();
                            }
                        });
                    });
                });
                
                peer.on('error', function(err) {
                    updateStatus(senderStatus, 'é”™è¯¯: ' + err, 'error');
                    startSendingBtn.disabled = false;
                    startSendingBtn.textContent = 'å¼€å§‹ä¼ è¾“';
                });
            }
            
            function sendFilesData() {
                updateStatus(senderStatus, 'æ­£åœ¨å‘é€æ–‡ä»¶æ•°æ®...', 'connecting');
                
                // é‡ç½®ä¼ è¾“çŠ¶æ€
                currentFileIndex = 0;
                currentFileOffset = 0;
                totalSent = 0;
                
                function sendNextFile() {
                    if(currentFileIndex >= currentFiles.length) {
                        // æ‰€æœ‰æ–‡ä»¶å‘é€å®Œæˆ
                        conn.send({ type: 'transfer-complete' });
                        updateStatus(senderStatus, 'æ‰€æœ‰æ–‡ä»¶å‘é€å®Œæˆ', 'connected');
                        startSendingBtn.disabled = false;
                        startSendingBtn.textContent = 'å¼€å§‹ä¼ è¾“';
                        return;
                    }
                    
                    const file = currentFiles[currentFileIndex];
                    const chunkSize = 256 * 1024; // 256KB chunks
                    
                    fileReader.onload = function(e) {
                        conn.send({
                            type: 'file-chunk',
                            fileIndex: currentFileIndex,
                            data: e.target.result,
                            offset: currentFileOffset,
                            total: file.size
                        });
                        
                        currentFileOffset += e.target.result.byteLength;
                        totalSent += e.target.result.byteLength;
                        
                        // æ›´æ–°æ€»è¿›åº¦
                        const percent = Math.round((totalSent / totalSize) * 100);
                        updateProgress(senderProgressBar, senderProgressText, percent);
                        
                        if (currentFileOffset < file.size) {
                            // ç»§ç»­å‘é€å½“å‰æ–‡ä»¶çš„ä¸‹ä¸€å—
                            readNextChunk(file, currentFileOffset, chunkSize);
                        } else {
                            // å½“å‰æ–‡ä»¶å‘é€å®Œæˆï¼Œè½¬åˆ°ä¸‹ä¸€ä¸ªæ–‡ä»¶
                            currentFileIndex++;
                            currentFileOffset = 0;
                            sendNextFile();
                        }
                    };
                    
                    // å¼€å§‹å‘é€å½“å‰æ–‡ä»¶
                    readNextChunk(file, currentFileOffset, chunkSize);
                }
                
                // å¼€å§‹å‘é€ç¬¬ä¸€ä¸ªæ–‡ä»¶
                sendNextFile();
            }
            
            // æ¥æ”¶ç«¯é€»è¾‘
            startReceivingBtn.addEventListener('click', startReceiving);
            
            function startReceiving() {
                currentCode = receiverCodeInput.value.trim();
                
                if (!currentCode) {
                    updateStatus(receiverStatus, 'è¯·è¾“å…¥ä¼ è¾“ä»£å·', 'error');
                    return;
                }
                
                // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
                startReceivingBtn.disabled = true;
                startReceivingBtn.textContent = 'æ­£åœ¨è¿æ¥...';
                
                // åˆå§‹åŒ–Peer
                peer = new Peer(currentCode + '-receiver', {
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' }
                        ]
                    }
                });
                
                peer.on('open', function(id) {
                    updateStatus(receiverStatus, 'æ­£åœ¨è¿æ¥å‘é€æ–¹...', 'connecting');
                    startReceivingBtn.textContent = 'ç­‰å¾…å‘é€æ–¹...';
                    
                    // è¿æ¥åˆ°å‘é€æ–¹
                    conn = peer.connect(currentCode + '-sender');
                    
                    conn.on('open', function() {
                        updateStatus(receiverStatus, 'å·²è¿æ¥åˆ°å‘é€æ–¹ï¼Œç­‰å¾…æ–‡ä»¶ä¿¡æ¯...', 'connected');
                        startReceivingBtn.textContent = 'ç­‰å¾…æ–‡ä»¶ä¿¡æ¯...';
                        
                        // å‡†å¤‡æ¥æ”¶æ•°æ®
                        receivedFiles = [];
                        isReceivingConfirmed = false;
                        
                        conn.on('data', function(data) {
                            if (data.type === 'files-info') {
                                // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                                pendingFilesInfo = data.files;
                                totalSize = data.totalSize;
                                showConfirmationDialog(data);
                                startReceivingBtn.textContent = 'ç­‰å¾…ç¡®è®¤...';
                            } 
                            else if (data.type === 'file-chunk' && isReceivingConfirmed) {
                                // ç¡®ä¿æ–‡ä»¶å¯¹è±¡å·²åˆ›å»º
                                if(!receivedFiles[data.fileIndex]) {
                                    receivedFiles[data.fileIndex] = {
                                        chunks: [],
                                        name: pendingFilesInfo[data.fileIndex].name,
                                        type: pendingFilesInfo[data.fileIndex].type,
                                        size: pendingFilesInfo[data.fileIndex].size
                                    };
                                }
                                
                                // å­˜å‚¨æ•°æ®å—
                                receivedFiles[data.fileIndex].chunks.push({
                                    offset: data.offset,
                                    data: data.data
                                });
                                
                                // è®¡ç®—å·²æ¥æ”¶å¤§å°
                                let receivedSize = 0;
                                receivedFiles.forEach(file => {
                                    if(file && file.chunks) {
                                        file.chunks.forEach(chunk => {
                                            receivedSize += chunk.data.byteLength;
                                        });
                                    }
                                });
                                
                                // æ›´æ–°æ€»è¿›åº¦
                                const percent = Math.round((receivedSize / totalSize) * 100);
                                updateProgress(receiverProgressBar, receiverProgressText, percent);
                                
                                updateStatus(receiverStatus, `æ­£åœ¨æ¥æ”¶æ–‡ä»¶æ•°æ® (${percent}%)`, 'connecting');
                                startReceivingBtn.textContent = `æ¥æ”¶ä¸­ ${percent}%`;
                            } 
                            else if (data.type === 'transfer-complete' && isReceivingConfirmed) {
                                // æ‰€æœ‰æ–‡ä»¶æ¥æ”¶å®Œæˆ
                                updateStatus(receiverStatus, 'æ–‡ä»¶æ¥æ”¶å®Œæˆ', 'connected');
                                startReceivingBtn.disabled = false;
                                startReceivingBtn.textContent = 'å¼€å§‹æ¥æ”¶';
                                
                                // é‡ç»„æ‰€æœ‰æ–‡ä»¶
                                assembleReceivedFiles();
                            }
                        });
                    });
                });
                
                peer.on('error', function(err) {
                    updateStatus(receiverStatus, 'é”™è¯¯: ' + err, 'error');
                    startReceivingBtn.disabled = false;
                    startReceivingBtn.textContent = 'å¼€å§‹æ¥æ”¶';
                });
            }
            
            function showConfirmationDialog(data) {
                const totalSize = data.totalSize;
                dialogMessage.textContent = `æœ‰ç”¨æˆ·æƒ³è¦å‘æ‚¨å‘é€ ${data.files.length} ä¸ªæ–‡ä»¶ (å…± ${formatFileSize(totalSize)})ï¼Œæ˜¯å¦æ¥æ”¶ï¼Ÿ`;
                
                // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
                incomingFilesList.innerHTML = '';
                data.files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-item-name">${file.name}</div>
                        <div class="file-item-size">${formatFileSize(file.size)}</div>
                    `;
                    incomingFilesList.appendChild(fileItem);
                });
                
                confirmationDialog.style.display = 'flex';
            }
            
            // ç¡®è®¤æ¥æ”¶æŒ‰é’®
            confirmReceiveBtn.addEventListener('click', function() {
                isReceivingConfirmed = true;
                confirmationDialog.style.display = 'none';
                updateStatus(receiverStatus, 'å·²ç¡®è®¤æ¥æ”¶ï¼Œç­‰å¾…æ•°æ®...', 'connected');
                receiverProgress.style.display = 'block';
                conn.send({ type: 'receive-confirmed' });
                startReceivingBtn.textContent = 'å‡†å¤‡æ¥æ”¶...';
            });
            
            // å–æ¶ˆæ¥æ”¶æŒ‰é’®
            cancelReceiveBtn.addEventListener('click', function() {
                confirmationDialog.style.display = 'none';
                updateStatus(receiverStatus, 'å·²æ‹’ç»æ¥æ”¶æ–‡ä»¶', 'error');
                conn.send({ type: 'receive-canceled' });
                conn.close();
                startReceivingBtn.disabled = false;
                startReceivingBtn.textContent = 'å¼€å§‹æ¥æ”¶';
            });
            
            function assembleReceivedFiles() {
                // å¤„ç†æ¯ä¸ªæ¥æ”¶åˆ°çš„æ–‡ä»¶
                receivedFiles.forEach((fileInfo, index) => {
                    if(!fileInfo || !fileInfo.chunks) return;
                    
                    // æŒ‰åç§»é‡æ’åºå—
                    fileInfo.chunks.sort((a, b) => a.offset - b.offset);
                    
                    // åˆå¹¶æ‰€æœ‰ArrayBuffer
                    const buffer = new Uint8Array(fileInfo.size);
                    
                    fileInfo.chunks.forEach(chunk => {
                        buffer.set(new Uint8Array(chunk.data), chunk.offset);
                    });
                    
                    // åˆ›å»ºBlob
                    const blob = new Blob([buffer], { type: fileInfo.type });
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileInfo.name || `file_${index + 1}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
                
                // æ˜¾ç¤ºæ¥æ”¶åˆ°çš„æ–‡ä»¶é¢„è§ˆ
                showFilesPreview(pendingFilesInfo, receiverPreview);
            }
            
            function showFilesPreview(files, container) {
                container.innerHTML = '';
                
                if(files.length === 0) {
                    container.style.display = 'none';
                    return;
                }
                
                container.style.display = 'block';
                
                files.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'file-info';
                    
                    const fileIcon = document.createElement('div');
                    fileIcon.className = 'file-icon';
                    fileIcon.innerHTML = getFileIcon(file.name || file.type);
                    
                    const fileDetails = document.createElement('div');
                    fileDetails.className = 'file-details';
                    
                    const fileName = document.createElement('div');
                    fileName.className = 'file-name';
                    fileName.textContent = file.name || 'æœªçŸ¥æ–‡ä»¶';
                    
                    const fileSize = document.createElement('div');
                    fileSize.className = 'file-size';
                    fileSize.textContent = formatFileSize(file.size);
                    
                    fileDetails.appendChild(fileName);
                    fileDetails.appendChild(fileSize);
                    fileDiv.appendChild(fileIcon);
                    fileDiv.appendChild(fileDetails);
                    container.appendChild(fileDiv);
                });
            }
            
            function getFileIcon(filename) {
                if(!filename) return 'ğŸ“';
                
                const ext = filename.split('.').pop().toLowerCase();
                const type = filename.split('/')[0];
                
                const icons = {
                    // å›¾ç‰‡
                    png: 'ğŸ–¼ï¸', jpg: 'ğŸ–¼ï¸', jpeg: 'ğŸ–¼ï¸', gif: 'ğŸ–¼ï¸', bmp: 'ğŸ–¼ï¸', svg: 'ğŸ–¼ï¸', webp: 'ğŸ–¼ï¸',
                    // è§†é¢‘
                    mp4: 'ğŸ¬', mov: 'ğŸ¬', avi: 'ğŸ¬', mkv: 'ğŸ¬', webm: 'ğŸ¬', wmv: 'ğŸ¬',
                    // éŸ³é¢‘
                    mp3: 'ğŸµ', wav: 'ğŸµ', ogg: 'ğŸµ', flac: 'ğŸµ', aac: 'ğŸµ',
                    // æ–‡æ¡£
                    pdf: 'ğŸ“„', doc: 'ğŸ“„', docx: 'ğŸ“„', xls: 'ğŸ“„', xlsx: 'ğŸ“„', ppt: 'ğŸ“„', pptx: 'ğŸ“„', txt: 'ğŸ“„',
                    // å‹ç¼©æ–‡ä»¶
                    zip: 'ğŸ—œï¸', rar: 'ğŸ—œï¸', '7z': 'ğŸ—œï¸', tar: 'ğŸ—œï¸', gz: 'ğŸ—œï¸',
                    // ä»£ç 
                    html: 'ğŸ“', css: 'ğŸ“', js: 'ğŸ“', json: 'ğŸ“', xml: 'ğŸ“', php: 'ğŸ“', py: 'ğŸ“', java: 'ğŸ“', cpp: 'ğŸ“', h: 'ğŸ“',
                    // å…¶ä»–
                    exe: 'âš™ï¸', dmg: 'ğŸ’½', pkg: 'ğŸ“¦', 
                    default: 'ğŸ“'
                };
                
                return icons[ext] || icons[type] || icons.default;
            }
            
            // è¾…åŠ©å‡½æ•°
            function readNextChunk(file, offset, chunkSize) {
                const fileSlice = file.slice(offset, offset + chunkSize);
                fileReader.readAsArrayBuffer(fileSlice);
            }
            
            function updateStatus(element, message, type) {
                element.textContent = message;
                element.className = 'status ' + type;
            }
            
            function updateProgress(progressBar, progressText, percent) {
                progressBar.style.width = percent + '%';
                progressText.textContent = percent + '%';
            }
            
            function formatFileSize(bytes) {
                if (typeof bytes !== 'number' || isNaN(bytes)) return 'æœªçŸ¥å¤§å°';
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            function resetAll() {
                // é‡ç½®æ‰€æœ‰çŠ¶æ€
                if (peer) {
                    peer.destroy();
                    peer = null;
                }
                
                if (conn) {
                    conn.close();
                    conn = null;
                }
                
                senderStatus.className = 'status';
                senderStatus.textContent = '';
                senderPreview.style.display = 'none';
                senderPreview.innerHTML = '';
                senderProgress.style.display = 'none';
                senderProgressBar.style.width = '0%';
                senderProgressText.textContent = '0%';
                
                receiverStatus.className = 'status';
                receiverStatus.textContent = '';
                receiverPreview.style.display = 'none';
                receiverPreview.innerHTML = '';
                receiverProgress.style.display = 'none';
                receiverProgressBar.style.width = '0%';
                receiverProgressText.textContent = '0%';
                
                fileInput.value = '';
                senderCodeInput.value = '';
                receiverCodeInput.value = '';
                
                confirmationDialog.style.display = 'none';
                currentFiles = [];
                receivedFiles = [];
                currentCode = '';
                isReceivingConfirmed = false;
                pendingFilesInfo = [];
                currentFileIndex = 0;
                currentFileOffset = 0;
                totalSent = 0;
                totalSize = 0;
                
                fileList.style.display = 'none';
                fileList.innerHTML = '';
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                startSendingBtn.disabled = false;
                startSendingBtn.textContent = 'å¼€å§‹ä¼ è¾“';
                startReceivingBtn.disabled = false;
                startReceivingBtn.textContent = 'å¼€å§‹æ¥æ”¶';
            }
            
            // åˆå§‹åŒ–PeerJSåº“
            function initPeerJS() {
                if(typeof Peer === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js';
                    script.onload = function() {
                        console.log('PeerJS loaded successfully');
                    };
                    script.onerror = function() {
                        console.error('Failed to load PeerJS');
                        updateStatus(senderStatus, 'æ— æ³•åŠ è½½PeerJSåº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                        updateStatus(receiverStatus, 'æ— æ³•åŠ è½½PeerJSåº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                    };
                    document.body.appendChild(script);
                }
            }
            
            // åˆå§‹åŒ–åº”ç”¨
            initPeerJS();
        });
    </script>
</body>
</html>
